name: Bump Version and Create Release

on:
  pull_request:
    types: [closed]
    branches:
      - main
      - development

jobs:
  bump-version:
    name: Bump Version and Create Release
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }} # ใช้ PAT ตรงนี้เพื่อให้มีสิทธิ์ Push ตลอดทั้ง Job
          fetch-depth: 0

      - name: Configure Git with PAT Identity
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }} # ใช้ PAT ในการยิง API เช็คตัวเอง
        run: |
          # 1. ยิง API ถาม GitHub ว่า PAT นี้เป็นของใคร
          USER_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user)
          
          # 2. ดึง Login Name และ ID
          USER_LOGIN=$(echo "$USER_INFO" | jq -r .login)
          USER_ID=$(echo "$USER_INFO" | jq -r .id)
          
          # 3. ดึง Email (ถ้าเจ้าของ PAT ซ่อน Email ไว้ ให้ใช้รูปแบบ no-reply ของ GitHub)
          USER_EMAIL=$(echo "$USER_INFO" | jq -r .email)
          if [ "$USER_EMAIL" == "null" ]; then
            USER_EMAIL="${USER_ID}+${USER_LOGIN}@users.noreply.github.com"
          fi
          
          echo "Configuring Git as: $USER_LOGIN <$USER_EMAIL>"
          
          # 4. Set Config
          git config user.name "$USER_LOGIN"
          git config user.email "$USER_EMAIL"

      - name: Get Current Version
        id: current_version
        run: |
          # หา Tag ล่าสุดที่เป็นรูปแบบ vX.Y.Z หรือ vX.Y.Z-dev.N
          # ใช้ git describe เพื่อความแม่นยำ หรือ sort -V หากต้องการแค่ list
          LATEST_TAG=$(git tag -l 'v*' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | sort -V | tail -n1)

          if [ -z "$LATEST_TAG" ]; then
            echo "No tags found. Defaulting to v0.0.0"
            CURRENT_VERSION="0.0.0"
          else
            echo "Found latest tag: $LATEST_TAG"
            CURRENT_VERSION="${LATEST_TAG#v}"
          fi

          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Calculate New Version
        id: new_version
        env:
          CURRENT_VERSION: ${{ steps.current_version.outputs.version }}
          TARGET_BRANCH: ${{ github.event.pull_request.base.ref }}
          SOURCE_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          echo "Target: $TARGET_BRANCH | Source: $SOURCE_BRANCH | Current: $CURRENT_VERSION"

          # แยก Version เป็นส่วนๆ (Major.Minor.Patch) และส่วน Suffix (ถ้ามี)
          # ลบ Suffix (-dev.X) ออกก่อนเพื่อหา Base Version
          BASE_VERSION=${CURRENT_VERSION%%-*}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"

          NEW_VERSION=""

          # ==========================================
          # LOGIC: Merge to MAIN (Production Release)
          # ==========================================
          if [ "$TARGET_BRANCH" == "main" ]; then
            
            if [ "$SOURCE_BRANCH" == "development" ]; then
              # Release Flow: development -> main (Minor Bump)
              # ex. 0.1.0 -> 0.2.0
              NEW_MINOR=$((MINOR + 1))
              NEW_VERSION="$MAJOR.$NEW_MINOR.0"
              echo "Strategy: Minor bump (Release)"
            else
              # Hotfix Flow: hotfix/* -> main (Patch Bump)
              # ex. 0.1.0 -> 0.1.1
              NEW_PATCH=$((PATCH + 1))
              NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
              echo "Strategy: Patch bump (Hotfix)"
            fi

          # ==========================================
          # LOGIC: Merge to DEVELOPMENT (Dev Build)
          # ==========================================
          elif [ "$TARGET_BRANCH" == "development" ]; then
            
            # ตรวจสอบว่าเวอร์ชันปัจจุบันเป็น dev อยู่แล้วหรือไม่
            if [[ "$CURRENT_VERSION" == *"-dev."* ]]; then
              # ถ้าเป็น dev อยู่แล้ว ให้เพิ่มเลขต่อท้าย
              # ex. 0.1.0-dev.1 -> 0.1.0-dev.2
              LAST_NUM=${CURRENT_VERSION##*.}
              NEXT_NUM=$((LAST_NUM + 1))
              NEW_VERSION="${BASE_VERSION}-dev.${NEXT_NUM}"
            else
              # ถ้ามาจาก version ปกติ ให้เริ่มนับ dev.1
              # ex. 0.1.0 -> 0.1.0-dev.1
              NEW_VERSION="${BASE_VERSION}-dev.1"
            fi
            echo "Strategy: Dev increment"

          else
            echo "Error: Unknown target branch '$TARGET_BRANCH'"
            exit 1
          fi

          echo "New Version Computed: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Push New Tag
        run: |
          NEW_VERSION=${{ steps.new_version.outputs.version }}
          TAG_NAME="v$NEW_VERSION"
          
          echo "Pushing tag $TAG_NAME"
          
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          # ไม่ต้อง set-url เพราะใช้ token ในขั้นตอน checkout แล้ว
          git push origin "$TAG_NAME"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: github.event.pull_request.base.ref == 'main'
        # Release ใช้ GITHUB_TOKEN ปกติได้ หรือจะใช้ PAT ก็ได้ถ้าต้องการ trigger workflow อื่นต่อ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.new_version.outputs.version }}
          name: Release ${{ steps.new_version.outputs.version }}
          generate_release_notes: true # ให้ GitHub Gen Note อัตโนมัติจาก PR
          body: |
            ## Release Details
            - **Version:** ${{ steps.new_version.outputs.version }}
            - **Previous:** ${{ steps.current_version.outputs.version }}
            - **PR:** #${{ github.event.pull_request.number }}
            - **Branch:** ${{ github.event.pull_request.head.ref }} &rarr; ${{ github.event.pull_request.base.ref }}
            - **Merged by:** @${{ github.event.pull_request.merged_by.login }}